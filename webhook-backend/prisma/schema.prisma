generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subscriptions WebhookSubscription[]
}

model WebhookSubscription {
  id          String             @id @default(uuid())
  sourceUrl   String
  callbackUrl String
  secret      String?
  status      SubscriptionStatus @default(ACTIVE)
  eventTypes  String[]           @default([])
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  events WebhookEvent[]

  @@index([userId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
}

model WebhookEvent {
  id        String      @id @default(uuid())
  payload   Json
  headers   Json?
  eventType String?
  source    String?
  status    EventStatus @default(RECEIVED)
  attempts  Int         @default(0)
  lastError String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  subscriptionId String
  subscription   WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  deliveryAttempts DeliveryAttempt[]

  @@index([subscriptionId])
  @@index([status])
}

enum EventStatus {
  RECEIVED
  PROCESSING
  DELIVERED
  FAILED
}

model DeliveryAttempt {
  id                  String          @id @default(uuid())
  attemptNumber       Int
  status              DeliveryStatus
  httpStatus          Int?
  responseBodySnippet String?
  errorMessage        String?
  nextRetryAt         DateTime?
  createdAt           DateTime        @default(now())

  eventId String
  event   WebhookEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([nextRetryAt])
}

enum DeliveryStatus {
  SUCCESS
  FAILED
}
